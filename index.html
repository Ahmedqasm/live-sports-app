<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مشغل القنوات الاحترافي</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background: #0b0e14; color: white; font-family: sans-serif; margin: 0; text-align: center; }
        .header { background: #000; padding: 10px; border-bottom: 3px solid #238636; position: sticky; top: 0; z-index: 1000; }
        video { width: 100%; max-width: 800px; aspect-ratio: 16/9; background: #000; }
        #list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; padding: 20px; }
        .card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.3s; }
        .card:hover { border-color: #238636; transform: translateY(-5px); }
        .name { font-size: 13px; font-weight: bold; margin-top: 10px; color: #adbac7; }
        .btn-play { background: #238636; color: white; border: none; padding: 10px; border-radius: 5px; margin-top: 5px; cursor: pointer; width: 100%; }
    </style>
</head>
<body>

<div class="header">
    <video id="video" controls autoplay playsinline></video>
</div>

<div id="list">جاري جلب قائمة القنوات...</div>

<script>
    // الرابط الذي أرسلته (قمت بتحويله ليعمل عبر وسيط لفك الحظر)
    const M3U_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://xapi-ie.org/get.php?username=TEST10&password=test10&type=m3u_plus');

    async function load() {
        try {
            const response = await fetch(M3U_URL);
            const data = await response.text();
            render(data);
        } catch (e) {
            document.getElementById('list').innerHTML = "خطأ في الاتصال. تأكد من تفعيل إضافة CORS.";
        }
    }

    function render(data) {
        const listDiv = document.getElementById('list');
        listDiv.innerHTML = '';
        const lines = data.split('\n');
        
        lines.forEach((line, i) => {
            if (line.includes('#EXTINF:')) {
                const name = line.split(',')[1] || "قناة مباشرة";
                let url = lines[i + 1]?.trim();
                
                if (url && url.startsWith('http')) {
                    // تحويل روابط http العادية لتمر عبر بروكسي لضمان التشغيل على https
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `<div class="name">${name}</div><button class="btn-play">تشغيل</button>`;
                    card.onclick = () => play(url);
                    listDiv.appendChild(card);
                }
            }
        });
    }

    const video = document.getElementById('video');
    const hls = new Hls({
        xhrSetup: function(xhr, url) {
            xhr.withCredentials = false; // مهم لروابط التوكين
        }
    });

    function play(url) {
        // الخدعة هنا: نستخدم بروكسي مباشر للبث أيضاً لتفادي منع المتصفح للـ HTTP
        const finalUrl = url.replace('http://', 'https://corsproxy.io/?http://');
        
        if (Hls.isSupported()) {
            hls.loadSource(finalUrl);
            hls.attachMedia(video);
            video.play();
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = finalUrl;
            video.play();
        }
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    load();
</script>
</body>
</html>
